<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="manifest" href="manifest.json">
  <script src="./js/getpage.js"></script>
  <script src="./js/sendScrapBox.js"></script>
  <script  type="module" src="./js/main.js"></script>
  <title>Barcode Detection sample</title>
</head>

<body>

  <video id="player" muted autoplay></video>
  <div>
    Barcode text : <span id="rawValue"></span>
  </div>
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <div>
    <p class="title"></p>
    <p class="author"></p>
    <p class="pubdate"></p>
    <p class="description"></p>
  </div>
  <div class="form-block">
    <label class="flex-column">
      <span class="form-label">プロジェクトID:</span>
      <input class="form-input" id="js-shared-projectId">
    </label>
  </div>

  <div class="form-block">
    <label class="flex-column">
      <span class="form-label">ページ名:</span>
      <input class="form-input --title" id="js-shared-title">
    </label>
  </div>

  <div class="form-block">
    <button class="form-button" id="js-create-button" disabled onclick="sendScrapBox()">GO</button>
  </div>

  <div class="form-block">
    <label class="flex-column">
      <span class="form-label">本文:</span>
      <textarea class="form-textarea" id="js-shared-text"></textarea>
    </label>
  </div>
  <script>
    const video = document.getElementById('player');
    let videoTracks;
    let localStream = null;
    let captureTimer = null;
    const fps = 10;
    let medias = {
      video: {
        width: 320,
        height: 240,
        facingMode: {
          exact: "environment"
        }
      },
      audio: false
    };
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    startBtn.onclick = function() {
      document.getElementById(
        'rawValue'
      ).innerHTML = "";
      navigator.mediaDevices.getUserMedia(medias)
        .then(function(stream) {
          video.srcObject = stream;
          localStream = stream;
          if (window.BarcodeDetector) {
            const detector = new BarcodeDetector();
            detector.formats = "ean_13"
            captureTimer = setInterval(function() {
              detector.detect(video).then(
                function(barcodes) {
                  let barcode = null;
                  for (barcode of barcodes) {
                    console.log("value : " + barcode.rawValue);
                    console.log(barcode);
                    document.getElementById('rawValue').innerHTML =
                      convertLink(barcode.rawValue);
                    alert("call g");
                    getgapi(barcode.rawValue);
                    document.getElementById("js-create-button").disabled = false;
                  }
                  if (barcode) stopVideo();
                }).catch(function(err) {
                console.log(err);
              });
            }, 1000 / fps);
          } else {
            console.error(
              'BarcodeDetection is not enable!');
          }
          startBtn.disabled = true;
          stopBtn.disabled = false;
        }).catch(function(err) {
          console.log(err);
          medias = {
            video: {
              width: 320,
              height: 240
            },
            audio: false
          };
        });
    };

    function stopVideo() {
      clearInterval(captureTimer);
      localStream.getTracks().forEach(function(track) {
        track.stop();
      });
      localStream = null;
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
    stopBtn.onclick = function() {
      stopVideo();
    };

    function convertLink(str) {
      const regexpUrl =
        /((h?)(ttps?:\/\/[a-zA-Z0-9.\-_@:/~?%&;=+#',()*!]+))/g; // ']))/;
      const regexpLink = function(all, url, h, href) {
        return '<a href="h' + href + '">' + url + '</a>';
      }
      return str.replace(regexpUrl, regexpLink);
    };
    // load時にstart状態にする
    startBtn.click();
  </script>
</body>

</html>
